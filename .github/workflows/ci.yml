name: ğŸ” Continuous Integration

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

# åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡ï¼šåŒã˜PRã§è¤‡æ•°ã®CIå®Ÿè¡Œã‚’é˜²ã
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Lintãƒ»TypeCheckãƒ»ãƒ†ã‚¹ãƒˆã‚’ä¸¦åˆ—å®Ÿè¡Œ
  quality-check:
    name: ğŸ§¹ Code Quality Check
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        package: [backend]  # TODO: frontend, sharedè¿½åŠ äºˆå®š
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ§¹ Run ESLint
        run: pnpm --filter=${{ matrix.package }} lint
        continue-on-error: false

      - name: ğŸ” Run TypeScript Check
        run: pnpm --filter=${{ matrix.package }} typecheck
        continue-on-error: false

      - name: ğŸ§ª Run Tests
        run: pnpm --filter=${{ matrix.package }} test
        continue-on-error: false

      # ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆï¼ˆå°†æ¥å®Ÿè£…ï¼‰
      # - name: ğŸ“Š Generate Coverage Report
      #   run: pnpm --filter=${{ matrix.package }} test:coverage
      #   continue-on-error: true

  # å…¨ä½“çµ±åˆãƒã‚§ãƒƒã‚¯
  integration-check:
    name: ğŸ”— Integration Check
    runs-on: ubuntu-latest
    needs: [quality-check]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      # Cloudflare Workersé–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•ãƒ†ã‚¹ãƒˆ
      - name: ğŸ§ª Test Wrangler Dev Startup
        run: |
          cd packages/backend
          timeout 30s pnpm dev || exit_code=$?
          if [ ${exit_code} -eq 124 ]; then
            echo "âœ… Wrangler dev started successfully (timed out as expected)"
            exit 0
          elif [ ${exit_code} -eq 0 ]; then
            echo "âœ… Wrangler dev started successfully"
            exit 0
          else
            echo "âŒ Wrangler dev failed to start"
            exit 1
          fi

      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®ãƒ“ãƒ«ãƒ‰ç¢ºèª
      - name: ğŸ—ï¸ Build Check
        run: |
          echo "âœ… All quality checks passed!"
          echo "ğŸ“¦ Packages: backend"
          echo "ğŸ¯ Next: frontend, shared packages integration"

  # CIæˆåŠŸé€šçŸ¥
  ci-success:
    name: âœ… CI Success
    runs-on: ubuntu-latest
    needs: [quality-check, integration-check]
    if: success()
    
    steps:
      - name: ğŸ‰ All Checks Passed
        run: |
          echo "ğŸ‰ CI Pipeline completed successfully!"
          echo "âœ… Code quality checks passed"
          echo "âœ… TypeScript compilation successful" 
          echo "âœ… All tests passed"
          echo "âœ… Integration checks completed"
          echo ""
          echo "Ready for merge! ğŸš€"